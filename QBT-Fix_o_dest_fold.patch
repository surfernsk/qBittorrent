From 282981b56e03b3616cbd06d1c602b335455a15a0 Mon Sep 17 00:00:00 2001
From: Evgeny Lensky <surfernsk@gmail.com>
Date: Wed, 16 May 2018 02:03:12 +0700
Subject: [PATCH] Fix open destination folder with nautilus > 3.28 close #8923
 by @glassez

---
 src/base/utils/misc.cpp | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/src/base/utils/misc.cpp b/src/base/utils/misc.cpp
index 1d3ec29fb1..373518a412 100644
--- a/src/base/utils/misc.cpp
+++ b/src/base/utils/misc.cpp
@@ -67,6 +67,8 @@
 #if (defined(Q_OS_UNIX) && !defined(Q_OS_MAC)) && defined(QT_DBUS_LIB)
 #include <QDBusInterface>
 #include <QDBusMessage>
+#include <QRegExp>
+#include "base/utils/version.h"
 #endif
 #endif
 
@@ -627,8 +628,16 @@
     if ((output == "dolphin.desktop") || (output == "org.kde.dolphin.desktop"))
         proc.startDetached("dolphin", QStringList() << "--select" << Utils::Fs::toNativePath(path));
     else if ((output == "nautilus.desktop") || (output == "org.gnome.Nautilus.desktop")
-             || (output == "nautilus-folder-handler.desktop"))
-        proc.startDetached("nautilus", QStringList() << "--no-desktop" << Utils::Fs::toNativePath(path));
+             || (output == "nautilus-folder-handler.desktop")) {
+        proc.start("nautilus", {"--version"});
+        proc.waitForFinished();
+        const QString nautilusVerStr = QString(proc.readLine().simplified()).remove(QRegExp("[^0-9.]"));
+        using NautilusVersion = Utils::Version<int, 3>;
+        if (NautilusVersion::tryParse(nautilusVerStr, {1, 0, 0}) > NautilusVersion {3, 28})
+            proc.startDetached("nautilus", QStringList() << Utils::Fs::toNativePath(path));
+        else
+            proc.startDetached("nautilus", QStringList() << "--no-desktop" << Utils::Fs::toNativePath(path));
+    }
     else if (output == "nemo.desktop")
         proc.startDetached("nemo", QStringList() << "--no-desktop" << Utils::Fs::toNativePath(path));
     else if ((output == "konqueror.desktop") || (output == "kfmclient_dir.desktop"))
